<?xml version="1.0" encoding="utf-8"?>
<openerp><data>

<!-- VIEWS -->
<record id="ticket_view_search" model="ir.ui.view">
  <field name="name">Search tickets</field>
  <field name="model">anytracker.ticket</field>
  <field name="type">search</field>
  <field name="priority" eval="8"/>
  <field name="arch" type="xml">
  <search string="Search tickets">
    <filter name="filter_projects"
            string="Projects"
            domain="[('parent_id','=',False)]"
            icon="terp-go-home"
            help="Show only toplevel tickets. They correspond to projects"/>
    <filter name="filter_nodes"
            string="Nodes"
            icon="terp-folder-green"
            help="Show only tickets which have sub-tickets. They are used to gather tickets by nodes"/>
    <filter name="filter_tasks"
            string="Tasks"
            domain="[('child_ids','=',False)]"
            icon="terp-check"
            help="Show only leaf tickets. They correspond to tasks"/>
    <separator orientation="vertical"/>
    <filter name="tickets_by_project"
            string="By project"
            context="{'group_by': ['project_id', 'parent_id']}"
            icon="gtk-indent"
            help="Group tasks"/>
    <field name="parent_id" widget="dynatree_selection"
           operator="child_of"
           options='{"child_field": "child_ids"}'
           string="Nodes"/>
    <field name="number" select="True"/>
    <field name="name" select="True"/>
    <field name="description"/>
    <field name="id" invisible="1"/>
  </search>
  </field>
</record>

<record id="ticket_view_tree" model="ir.ui.view">
  <field name="name">Tickets</field>
  <field name="model">anytracker.ticket</field>
  <field name="type">tree</field>
  <field name="priority" eval="10"/>
  <field name="arch" type="xml">
    <tree string="Ticket treeview">
      <field name="number"/>
      <field name="name"/>
      <field name="project_id"/>
      <field name="parent_id" invisible="1"/>
      <field name="shortened_description"/>
      <field name="create_date"/>
      <field name="write_date"/>
    </tree>
  </field>
</record>

<record id="ticket_view_form" model="ir.ui.view">
  <field name="name">ticket.form</field>
  <field name="model">anytracker.ticket</field>
  <field name="type">form</field>
  <field name="priority" eval="10"/>
  <field name="arch" type="xml">
    <form string="ticket form">
        <group col="2" colspan="4">
            <group col="8" colspan="2">
                <field name="parent_id" colspan="4" domain="[('child_ids','!=',False)]"/>
                <field name="method_id" widget="selection" attrs="{'readonly': [('parent_id', '!=', False)]}"/>
            </group>
            <group col="8" colspan="2">
                <field name="name" colspan="6" select="1"/>
                <field name="number" readonly="1"/>
            </group>
            <field name="description" colspan="2"/>
        </group>

      <notebook colspan="4">

        <page string="Sub-tickets">
          <field name="child_ids" nolabel="1" context="{'default_parent_id': active_id}"/>
        </page>
        <page string="Participants" attrs="{'invisible': [('parent_id', '!=', False)]}">
          <field name="participant_ids"/>
        </page>

        <page string="History" groups="anytracker.group_member">
        <group groups="anytracker.group_member">
          <field name="history_ids" nolabel="1" colspan="4" readonly="1" groups="anytracker.group_member">
            <tree string="History">
              <field name="create_uid" groups="anytracker.group_member"/>
              <field name="create_date" groups="anytracker.group_member"/>
              <field name="modification" groups="anytracker.group_member"/>
            </tree>
          </field>
        </group>
        </page>
      </notebook>
    </form>
  </field>
</record>

<!-- Ticket Kanban View  -->
<record model="ir.ui.view" id="tickets_view_kanban">
  <field name="name">Anytracker - tickets</field>
  <field name="model">anytracker.ticket</field>
  <field name="type">kanban</field>
  <field name="arch" type="xml">
    <kanban version="7.0" default_group_by="stage_id">
      <field name="color"/>
      <field name="number"/>
      <field name="permalink"/>
      <field name="name"/>
      <field name="description"/>
      <field name="kanban_description"/>
      <field name="siblings_ids"/>
      <field name="child_ids"/>
      <field name="assigned_user_email"/>
      <field name="assigned_user_id"/>
      <templates>
        <t t-name="ticket_details">
            <div><i><b><field name="breadcrumb"/></b><span> </span>(#<b><field name="number"/></b>)</i></div>
            <div><t t-raw="record.kanban_description.raw_value"/></div>
        </t>
        <t t-name="kanban-box">
          <div t-attf-class="#{kanban_color(record.color.raw_value)} oe_kanban_card oe_kanban_project oe_kanban_global_click">
            <div class="oe_dropdown_toggle oe_dropdown_kanban" groups="base.group_user">
               <span class="oe_e">í</span>
               <ul class="oe_dropdown_menu">
                   <t t-if="widget.view.is_action_enabled('edit')"><li><a type="edit">Edit ticket</a></li></t>
               </ul>
            </div>

            <div class="oe_kanban_content">
              <h4><field name="name"/></h4>
                <div>
                  <t t-raw="record.kanban_description.raw_value"/>
                </div>

                <div class="oe_kanban_bottom_left">
                <t groups="base.group_user">
                   <img t-att-src="kanban_gravatar(record.assigned_user_email.value, 22)"
                         class="oe_kanban_gravatar" t-att-title="record.assigned_user_id.value"/>
                   <a type="action" name="%(action_assign_to_current_user)d" string="Assign to me">
                        <img width="16" height="16" src="/anytracker/static/src/img/cart_put.png"/></a>
                   <a t-attf-href="#{record.permalink.value}" string="Permalink">¶</a>
                </t>
                </div>


            </div>
          </div>
        </t>
      </templates>
    </kanban>
  </field>
</record>

<!-- hierarchical view for the tickets -->
<record id="tickets_hierarchy" model="ir.ui.view">
  <field name="name">anytracker.ticket.hierarchy</field>
  <field name="model">anytracker.ticket</field>
  <field name="type">tree</field>
  <field name="field_parent">child_ids</field>
  <field name="arch" type="xml">
    <tree string="Tickets hierarchy">
      <field name="name"/>
      <field name="nb_children"/>
    </tree>
  </field>
</record>

<!-- allow to click in the hierarchical view -->
<!-- Still impossible to open directly in the form view :'( -->
<record id="action_hierarchy_line_select" model="ir.actions.act_window">
    <field name="name">Tickets</field>
    <field name="res_model">anytracker.ticket</field>
    <field name="view_type">form</field>
    <field name="view_mode">kanban,tree,form</field>
    <field name="view_id" ref="tickets_view_kanban"/>
    <!-- The reload bug on the kanban view comes from the line below -->
    <field name="domain">[('id', 'child_of', active_id), ('progress', '&lt;', 100.0)]</field>
    <field name="context">{'search_default_filter_tasks': 1}</field>
</record>
<record id="ir_value_hierarchy_line_select" model="ir.values">
    <field name="key2">tree_but_open</field>
    <field name="model">anytracker.ticket</field>
    <field name="name">Open ticket</field>
    <field name="value" eval="'ir.actions.act_window,%d'%action_hierarchy_line_select"/>
</record>

<!-- ACTIONS -->
<record model="ir.actions.act_window" id="action_kanbans">
  <field name="name">Anytracker - Projects</field>
  <field name="res_model">anytracker.ticket</field>
  <field name="view_type">tree</field>
  <field name="view_id" ref="tickets_hierarchy"/>
  <field name="domain">[('parent_id', '=', False)]</field>
  <field name="help">To create a new ticket, open the tree below and click on the relevant parent ticket, then click on "Create"</field>
</record>

<record model="ir.actions.act_window" id="tickets_action_form">
  <field name="name">Anytracker - Ticket</field>
  <field name="res_model">anytracker.ticket</field>
  <field name="view_mode">tree,form,kanban</field>
  <field name="view_type">form</field>
  <field name="view_id" ref="ticket_view_form"/>
</record>

<record model="ir.actions.act_window" id="act_all_projects">
  <field name="name">All projects</field>
  <field name="res_model">anytracker.ticket</field>
  <field name="view_mode">tree,form</field>
  <field name="view_type">form</field>
  <field name="view_id" ref="ticket_view_tree"/>
  <field name="context">{'search_default_filter_projects': 1}</field>
</record>
<record model="ir.actions.act_window" id="act_all_nodes">
  <field name="name">All nodes</field>
  <field name="res_model">anytracker.ticket</field>
  <field name="view_mode">tree,form</field>
  <field name="view_type">form</field>
  <field name="view_id" ref="ticket_view_tree"/>
  <field name="context">{'search_default_filter_nodes': 1}</field>
</record>
<record model="ir.actions.act_window" id="act_all_tasks">
  <field name="name">All tasks</field>
  <field name="res_model">anytracker.ticket</field>
  <field name="view_mode">tree,form</field>
  <field name="view_type">form</field>
  <field name="view_id" ref="ticket_view_tree"/>
  <field name="context">{'search_default_filter_tasks': 1}</field>
</record>

<!-- MENUITEMS -->
<menuitem id="anytracker"
  name="Anytracker"
  sequence="-1"
  web_icon="images/iconbw.png"
  web_icon_hover="images/icon.png" />
<menuitem id="menu_kanbans"
  name="Anytracker"
  parent="anytracker"
  sequence="0"/>
<menuitem id="submenu_kanbans"
  name="Ticket tree"
  parent="menu_kanbans"
  action="action_kanbans" />
<menuitem id="projects"
  name="Projects"
  sequence="10"
  parent="anytracker"/>
<menuitem id="tickets"
  name="Tickets"
  sequence="20"
  parent="anytracker"/>
    <menuitem id="menu_all_tasks"
      name="Tasks"
      parent="tickets"
      sequence="10"
      action="act_all_tasks" />
    <menuitem id="menu_all_nodes"
      name="Nodes"
      parent="tickets"
      sequence="20"
      action="act_all_nodes" />
    <menuitem id="menu_all_projects"
      name="Projects"
      parent="tickets"
      sequence="30"
      action="act_all_projects" />
<menuitem id="configuration"
  name="Configuration"
  sequence="200"
  groups="group_manager"
  parent="anytracker"/>

</data> </openerp>

